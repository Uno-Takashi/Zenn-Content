---
title: "1. そもそも非同期通信って何だろう？"
---


# django channelsって何だろう？

## 概要

この章では、すでにご承知の人も多いでしょうが『ウェブソケットとは何か？』『django-channelsとは何か？』といった前提知識を共有して行きます。本章を通して、WebsocketやDjango-channelsの歴史的経緯、django-channelsをアプリケーションに導入するメリットデメリットなどの基礎的な概要をご理解頂ければ幸いに思います。

従って、本章は技術に関する座学的な内容になります。「すでに知っているよ」「まずは作って覚える」という人は飛ばしていただいて構いません。

## 双方向非同期とは

双方向通信とは、

一般的なクライアントサーバー型のウェブサービスでは、クライアント側（ブラウザ）がリクエストを送信し、サーバー側はレスポンスを返すことによってデータの送受信を行います。すなわち通信の起点は必ずクライアント側でなくてはなりません。

しかしながら、サーバー側を起点にしてデータを送信したいというニーズが存在します。例えばチャットやSNSでは、クライアントの更新を待たずに、サーバーにデータが追加されたことを起点にしてデータの送受信を行いたいはずです。

このような需要を満たすため、クライアント、サーバーの双方が通信の起点となることが出来る通信方式を双方向通信になります。

## websocketとは？

以前はhttp上で双方向通信を実現するために、様々な工夫が施されていました。

html5以前では、httpロングポーリングやajax、cometといった技術を用いることで、クライアントサーバー型の通信方式を維持したまま、論理的には双方向通信を実現する手法が主流でした。

しかしながら、これらの方法は結局のところHTTP上に成り立っているため、各通信ごとにヘッダーファイルのやり取りや、サーバーの状態を確認するためだけの通信が発生することになります。そのため、トラフィックやリソース消費の増大といったデメリットを抱えていました。

websoketとはこうした双方向通信手法の問題点を解決しつつもHTTPのメリットを維持した、単一のプロトコルです。

まずwebsocketではHTTP/HTTPSと同様の方法でハンドシェイク(通信の確立)を行います。
その後、HTTP/HTTPSであれば、通信の修了後はセッションを切断しますが、websocketではセッションを維持し続けます。

## asgiアプリケーションとは？

asgiについて知るためには、まずはwsgi(Web Server Gateway Interface)について知っていなければなりません。wsgiとはpythonにおいてwebサーバーとwebアプリケーションが通信するための標準化された規格です。

asgi（Asynchronous Server Gateway Interface）とはwsgiの精神的な後続として開発されている、インターフェースになります。asgiはdjango projectが提案しており、その名の通りAsynchronous(非同期)処理をサポートしています。

また、Django Projectが監理する規格ではありますが、[FastAPI](https://fastapi.tiangolo.com/)や[quart](https://github.com/pgjones/quart)でも採用されています。

asgiサーバーとしては[Uvicorn](https://www.uvicorn.org/)、[Hypercorn](https://pgjones.gitlab.io/hypercorn/index.html)、[daphne](https://github.com/django/daphne)が[asgiのドキュメント](https://asgi.readthedocs.io/en/latest/implementations.html)に記載されています。

## django-channelsとは？

django-channelsとはdjangoにおいてasgiアプリケーションを開発するためのライブラリになります。

djangoとは別途でインストールする必要があるため、サードパーティー製アプリケーションのように見えますが、djangoのコアメンバーが開発に関係しているライブラリになります。

従ってchannelsのGithubリポジトリもdjangoと同様のorganaization内に存在している、事実上の公式ライブラリであり、Djangoにおいて非同期通信を実装したい場合のデファクトスタンダードでもあります。

また、本書においては、websocketを実装するためのツールとして利用しますが、django-channels自体はwebsocketに限定されたライブラリではありません。

# チャットアプリにおける懸念事項

## 非同期通信アプリケーションのチュートリアル≒チャットアプリ？

古来より（？）非同期通信を扱うアプリケーションのチュートリアルと言えばチャットアプリが作られていました。多くの非同期通信を行う書籍ではチャットアプリの作成を通して、そのフレームワークにおける非同期アプリケーションの作り方を学びます。

本書も例にもれず安易にチャットアプリをチュートリアルとして利用します。しかしながら、チャットアプリをチュートリアルとして扱う前に、著者から2点ほどお伝えしたい事項が存在しています。

### 法的懸念事項

一つ目は法的な観点からの懸念事項です。

サービスを作った場合そのクオリティによらず、公開したいというのが自然な心理であることは理解できます。近年の就職活動では、ポートフォリオとして作成したサービスの提出を求められる事も多いです。著者としてもそうした採用のスタイルは非常に好ましいと考えています。

しかしながら、サービスの公開には法的な障壁が存在しているパターンが存在します。

実は、本書やそれ以外の書籍でも扱われるチャットアプリはその典型であると言えます。

日本においてはクローズドチャットと定義されるサービスを運用する場合、電気通信事業者として届け出を行う事が電気通信事業法にて定められています。

:::details クローズド・チャット
サイト上にチャットルームを開設し、アクセスした利用者と不特定の会話希望者をマッチングしたうえで、両者間のみに閉じた会話等を媒介するものをいい、登録又は届出を要する電気通信事業者と判断される。
:::

クローズド・チャットの定義に該当するサービスを届け出を行わずに運用している場合、『三年以下の懲役若しくは二百万円以下の罰金』が課せられる可能性があります。

このクローズド・チャットの定義はややあいまいなところがありますが、仮にルーム機能と募集機能があるようなチャットアプリを作成すれば、それはこの定義に当てはまることになります。

実際問題、個人で作っている零細サービスにまでわざわざ罰金取りに行くかと言えば、そうではないでしょうが、気を付けるに越したことはありません。

本書のチュートリアルを実際に行っていただくのは、大変うれしい限りではありますが、サービスとしての公開にはリスクが存在することを念頭においていただきたいです。

### 非同期アプリケーション
